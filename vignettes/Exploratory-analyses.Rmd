---
title: "Exploratory analyses on barnacle nauplii outlines"
author: 
- Wong Jin Yung
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  rmarkdown::pdf_document:
    fig_caption: yes
    toc: true
    number_sections: true
    includes:  
      in_header: preamble-latex.tex
vignette: >
  %\VignetteIndexEntry{Exploratory analyses on barnacle nauplii outlines}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Among species comparison

This analysis use the dataset of stage II nauplii outlines digitized from the literature, which was included in package.

```{r, message = FALSE}
# load the stage II nauplii outline dataset from the current package
library(barnlarv)
data(stage2landmark)
```

## Nauplii outline description: Elliptic fourier analysis
Normalized elliptic Fourier analysis was performed to describe the shape of the outlines. 

```{r, message = FALSE, fig.cap="Normalized outlines of 103 species of stage II barnacle nauplii",  fig.align='center', fig.height=4, fig.width=4}
# wrapper function in 'otolith' package used to perform normalized EFA
require(otolith)
stage2.nef <- otolith::rNEF(stage2landmark)
stage2.coef <- stage2.nef$coef

# A quick inspection of the aligned outlines
.plotf(stage2.coef)
```

To reduce the dimension of the data (and possible noises in minute variations), number of harmonics used were reduced. To do this, the cumulative variations explained by the harmonics was first checked.

```{r}
# check the explained variations (first harmonics already excluded)
print(stage2.nef$expvar[1:50])
```

Harmonics 2-9 explained for >95% of variations of the data. This number will be used for subsequent analyses. Note: common practice do not use the first harmonic in normalized outline analysis but I only discard the first three coefficients and chose to retain the $d_1$ coefficient, which correspond to the relative width-on-length ratio (Claude, 2008)^[Claude, J. (2008). *Morphometrics with R*. NY:Springer]).

## Grouping the shape variations: principal component analysis and clustering

Principal component analysis (PCA) was then performed on the coefficients of 2-9 harmonics plus $d1$ coeffiecient of the first harmonic.

```{r}
# perform principal component analysis, note first three coefficients of the 
# first harmonic are not used
pca.stage2.nef <- prcomp(stage2.coef[, c(2:9, 100+2:9, 200+2:9, 300+1:9)])
```

Before plotting the result of PCA, clustering of the outline data was first performed. *k*-means clustering, a commonly used unsupervised learning algorithm was used here. Further reduction of the data dimension was done by reducing the number of prinncipal components (PC) used. To determine the suitable number of PC and *k*, a small evaluation was run to check the ratio of between cluster sum of squares to total sum of squares, which the higher the value indicates the better separation of clusters are.

```{r, fig.cap = "Evaluation of number of PC and k on the performance of k-means clustering", fig.align='center', fig.height=5, fig.width=5}
# initialize empty result
kmeans.result <- matrix(NA, 20, 20, dimnames = list(paste("k", 1:20), 
                                                    paste("PC", 1:20)))

# set fixed random number set for reproducible kmeans result 
set.seed(8888)

# loop thru different values of PC and k
for (i in 2:20) {
  for (j in 2:20){
    temp <- kmeans(pca.stage2.nef$x[, 1:j], i)
    kmeans.result[i, j] <- temp$betweenss / temp$totss
  }
}

# plot the result
matplot(1:20, kmeans.result, type = "l", lty = 1, xlab = "k", 
        ylab = "BetweenSS/ TotalSS", col = rainbow(20))
abline(v = 7, col = "gray", lty = 3)
legend("bottomright", col = rainbow(19), lty = 1, legend = 2:20, 
       title = "PC number", cex = 0.8, ncol = 2)
```

Two principal components and 7 *k* were chosen. *k*-means clustering was performed and the result of PCA is plotted with colour labelling based on the result of clustering.

```{r, fig.cap = "Principal component analysis plot of the barnacle larvae outlines overlaid with clustering result from k-means clustering", fig.align='center', fig.height=5, fig.width=5}
# perform k-means clustering with the chosen k and PC
kmeans.stage2.nef <- kmeans(pca.stage2.nef$x[, 1:2], 7)

# plot the PCA
empty_pca_stage2 <- expression({ # we are going to reuse this
  plot(pca.stage2.nef$x[, 1:2], type = "n",
       xlab = paste("PC1", "(", 
                    round(summary(pca.stage2.nef)$importance[, 1][2] * 100), 
                    "%)"),
       ylab = paste("PC2", "(", 
                    round(summary(pca.stage2.nef)$importance[, 2][2] * 100), 
                    "%)"));
  abline(v = 0, h = 0, lty = 3, col = "grey")}
)
eval(empty_pca_stage2)
points(pca.stage2.nef$x[, 1], pca.stage2.nef$x[, 2], pch = 21,  
       bg = (2:8)[kmeans.stage2.nef$cluster])

```

Clustering of the outlines was checked by visualizing the group outlines and their mean outline.

```{r, fig.cap = "Outlines of each cluster with their mean shape", fig.align='center', fig.width=9, fig.height=5}
stage2.clus <- kmeans.stage2.nef$cluster
stage2.clus.num <- length(levels(as.factor(stage2.clus)))
par(mfrow = c(2, 4), mar = rep(0, 4))
for (i in 1:stage2.clus.num) {
  .plotf(stage2.coef[which(stage2.clus == i), ], meancol = i+1, har = 9)
}
```

## Larval shape variations: correlation to trophic mode and size

The changes in outline shapes on the PCA-shape space were checked by reconstruct the outlines by performing inverse Fourier, this gave a general idea of the trend in the changes on the outlines.

```{r, fig.cap = "Outline shape at extreme PC values, plotted as thin-plate-spline deformation from the mean outlines. Note: these are just hypothetical shapes at the extreme of the PC axes", fig.align='center', fig.height=5, fig.width=5}
# re-construct the outlines, using 9 harmonics chosen earlier
.plot_pca_tps(stage2.coef, pca.stage2.nef, har = 9)
```

Result from the PCA analysis suggested that changes along PC1 appeared to be related to change in aspect ratio and changes along PC2 appeared to be related to the change in the length of the frontal horns. 

The main goal of the exploratory analyses was to identify the major trend in shape changes and explore the possible link of these changes to the potential underlying ecological or evolutionary causes. To explore the potential links to the trends of the shape changes, description data on the life history trait (trophic mode), size (from linear measurement) were used. Note: linear measurement of size (larval length) was chosen over centroid size as the measure because characteristic length (larval length) is believed to be more relevant to biomechanics.

```{r, fig.cap = "PCA plot of the outline data overlaid with larval size and trophic mode", fig.align='center', fig.height=5, fig.width=5}
# load the data file containing the linear measurements and trophic mode
stage2mdat <- read.csv(system.file("extdata/stage2",
                                   "frontal-horn-summary.csv",
                                   package = "barnlarv"))

# plot the empty_pca plot
eval(empty_pca_stage2)

# overlay with the trophic mode and size information
range01 <- function(x) {((x - min(x))/(max(x) - min(x)))} # size calculation
radius <- sqrt(stage2mdat$length / pi) # size calculation
radius <- range01(radius) * 2 + 0.5 # size calculation
points(pca.stage2.nef$x[, 1:2], cex = radius, 
       bg = c("lightsalmon", "lightskyblue")[as.integer(stage2mdat$diet)], 
       pch = 21)
legend("topleft", pt.cex = range01(sqrt(seq(200, 1000, 200) / pi)) * 3 + 0.5,
       pch = 21, legend = seq(200, 1000, 200), 
       title = expression(paste("Length(", mu, "m)")))
legend("topright", fill = c("lightsalmon", "lightskyblue"), 
       c("Lecithotrophic", "Planktotrophic"), bty = "n")
```

In the new overlaid plot, it appears that size generally increase along PC1 while trophic mode was separated by PC2. Contribution of larval length and trophic mode to the overall shape changes were checked. 

```{r, message=FALSE, results="hide"}
stage2.shape <- stage2.coef[, c(2:9, 100+2:9, 200+2:9, 300+1:9)]
stage2.diet <- as.factor(stage2mdat$diet)
stage2.length <- stage2mdat$length
stage2.lm1 <- geomorph::procD.lm(stage2.shape ~ stage2.length + stage2.diet, 
                               iter = 999)
stage2.lm1$aov.table
```

```{r, echo = FALSE}
knitr::kable(round(stage2.lm1$aov.table, 3))
```

Larval length and trophic mode accounted for $\approx 30$% and $\approx 8$% of shape variations.

The overlaid PCA plot also suggests that: 1) trend in change of aspect ratio may be correlated with the change in size, i.e. the longer the larvae are, the higher aspect ratio they have; 2) trend in change of frontal horn length may be correlated with the separation of trophic mode. These can be confirmed by using the data from the linear measurements.

```{r, fig.cap = "Confirmation of A) Relationship between aspect ratio and larval length and B) relationship between ratio of frontal horn length to larval length and trophic mode", fig.align = "center", fig.width=8, fig.height=5}
# Linear model of aspect ratio against larval length
stage2.asp.ratio <- stage2mdat$length / stage2mdat$width
asp.mod1 <- lm(log(stage2.asp.ratio) ~ stage2mdat$length)

# aspect ratio
par(mfrow = c(1, 2))
plot(stage2.asp.ratio ~ stage2mdat$length,
     xlab = expression(paste("Larvae length (", mu, "m)")), 
     ylab = "Aspect ratio")
points(sort(stage2mdat$length), sort(exp(predict(asp.mod1))), type = "l")
abline(v = 600, col = "gray", lty = 3)
title(main = "A",adj = 0, cex.main = 2)

# trophic mode
stage2.horn.ratio <- stage2mdat$horn / stage2mdat$length
boxplot(stage2.horn.ratio ~ stage2mdat$diet, 
        ylab = "Ratio of length of frontal horns to total length", 
        xlab = "Trophic mode")
title(main = "B", adj = 0, cex.main = 2)
```

In Figure A, the increase in aspect ratio grows exponentially with larval length, suggesting potential limitation to size evolution. Another possible interesting observation here is on the size distribution. It appears that few species of stage II barnacle nauplii have larval length greater than $600\mu m$

\newpage 

# Nauplii stages comparison

This analysis use a subset of outline data, which contained 12 species of barnacle nauplii outlines of all the developmental stages. This data is included in the package. 

## The data
```{r}
# load the semi-landmarks data and the description data
data(ontogeny_landmark)
ontogeny.mdat <- read.csv(system.file("extdata/ontogeny",
                                      "frontal-horn-summary.csv",
                                      package = "barnlarv"))

# outline of Octolasmis cor stage 1 did not align well
# This data point was removed from the subsequent analysis
rmidx <- which(dimnames(ontogeny_landmark)[[3]] == "Octolasmis-cor-1")
ontogeny.mdat <- ontogeny.mdat[-rmidx, ]
ontogeny.landmark <- ontogeny_landmark[, , -rmidx]
```

## EFA
Basically the analyses performed for across species comparison was repeated to explore the pattern in this across stages dataset. First normalized elliptic Fourier analysis was performed

```{r, fig.cap="Normalized outlines of 12 species of barnacle nauplii across developmental stages",  fig.align='center', fig.height=4, fig.width=4}
# species name used for plotting later
onto.species <- as.factor(paste(ontogeny.mdat$genus, ontogeny.mdat$species, 
                                sep = " "))

# NEF
ontogeny.nef <- otolith::rNEF(ontogeny.landmark)

# (NOT RUN) ontogeny.nef$expvar
# number of harmonics chosen to be 9, which explain for 95% variations

# A quick check on the outlines
.plotf(ontogeny.nef$coeff)
```

## PCA
Next, PCA was performed

```{r, fig.cap = paste("Plot of principal component analysis of the barnacle nauplii outlines for 12 species across different divelopmental stages.", paste(paste0(letters[1:length(levels(onto.species))], ": ", levels(onto.species)), collapse = "; ")), fig.align='center', fig.height=5, fig.width=5}
# PCA
pca.ontogeny.nef <- prcomp(ontogeny.nef$coeff[, c(2:9, 100+2:9, 
                                                  200+2:9, 300+1:9)])

# PCA plot
empty_pca_onto <- expression({ # we will use this again
  plot(pca.ontogeny.nef$x[, 1:2], type = "n",
       xlab = paste("PC1", "(", round(summary(
         pca.ontogeny.nef)$importance[, 1][2] * 100), "%)"),
       ylab = paste("PC2", "(", round(summary(
         pca.ontogeny.nef)$importance[, 2][2] * 100), "%)"))
  abline(v = 0, h = 0, lty = 3, col = "grey")
})
eval(empty_pca_onto)
text(pca.ontogeny.nef$x[, 1], pca.ontogeny.nef$x[, 2], letters[onto.species],
     col = rainbow(6)[ontogeny.mdat$stage])
legend("bottomright", fill = rainbow(6), 
       legend = levels(as.factor(ontogeny.mdat$stage)), cex = 0.8,
       ncol= 2, title = "Stage")
```

There is no apparent pattern here. Contribution of species and developmental stages to the shape variations was checked.

```{r, message=FALSE, results="hide"}
require(geomorph)
onto.shape <- ontogeny.nef$coeff[, c(2:9, 100+2:9, 200+2:9, 300+1:9)]
onto.stage <- as.factor(ontogeny.mdat$stage)
onto.lm1 <- geomorph::procD.lm(onto.shape ~ onto.stage + onto.species, iter = 999)
onto.lm1$aov.table
```

```{r, echo = FALSE}
knitr::kable(round(onto.lm1$aov.table, 3))
```

It is apparent that species still accounts for most of the shape variations.

Next, the general trends of shape changes in the PCA shape space were examined.

```{r, fig.caption = "Outline shape at extreme PC values, plotted as thin-plate-spline deformation from the mean outlines. Note: these are just hypothetical shapes at the extreme of the PC axes", fig.align = "center", fig.width=5, fig.height=5}

# Re-construct the outlines
.plot_pca_tps(ontogeny.nef$coeff, pca.ontogeny.nef, har = 9)
```

Again, PC1 is more related to change in aspect ratio while PC2 is more related to change in ratio of frontal horn length. This is not surprising as species difference still dominate the shape variation in this shape space.

## Correlation to trophic mode and size

```{r, fig.cap = paste("Plot of principal component analysis of the barnacle nauplii outlines for 12 species across different divelopmental stages.", paste(paste0(letters[1:length(levels(onto.species))], ": ", levels(onto.species)), collapse = "; ")), fig.align='center', fig.height=5, fig.width=5}
eval(empty_pca_onto)
onto.radius <- sqrt(ontogeny.mdat$length / pi) # size calculation
onto.radius <- range01(onto.radius) * 6 + 0.5 # size calculation
points(pca.ontogeny.nef$x[, 1], pca.ontogeny.nef$x[, 2], pch = 21,
     bg = c("lightsalmon", "lightskyblue")[as.integer(ontogeny.mdat$diet)], 
     cex = onto.radius, col = "white")
text(pca.ontogeny.nef$x[, 1], pca.ontogeny.nef$x[, 2], letters[onto.species],
     col = 1, cex = 0.7)
legend("bottomright", fill = c("lightsalmon", "lightskyblue"), 
       c("Lecithotrophic", "Planktotrophic"),
       bty = "n")
```

```{r, message=FALSE, results="hide"}
onto.diet <- as.factor(ontogeny.mdat$diet)
onto.length <- ontogeny.mdat$length
onto.lm2 <- geomorph::procD.lm(onto.shape ~ onto.length + onto.diet, 
                               iter = 999)
onto.lm2$aov.table
```

```{r, echo = FALSE}
knitr::kable(round(onto.lm2$aov.table, 3))
```
